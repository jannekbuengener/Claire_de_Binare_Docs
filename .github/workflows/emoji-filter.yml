name: ğŸš« Advanced Emoji Filter

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # TÃ¤glich um 2 Uhr (UTC) scannen
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      auto_fix:
        description: 'Auto-fix gefundene Emojis?'
        required: false
        default: 'false'
        type: boolean
      scan_path:
        description: 'Pfad zum Scannen'
        required: false
        default: '.'
        type: string

env:
  PYTHON_VERSION: '3.11'

jobs:
  emoji-detection:
    name: ğŸ” Emoji Detection
    runs-on: ubuntu-latest
    
    outputs:
      emojis-found: ${{ steps.scan.outputs.emojis-found }}
      blocked-count: ${{ steps.scan.outputs.blocked-count }}
      report-path: ${{ steps.scan.outputs.report-path }}
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # FÃ¼r vollstÃ¤ndige History
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        pip install --upgrade pip
        pip install regex emoji pyyaml
    
    - name: âš™ï¸ Validate Configuration
      run: |
        if [ ! -f .github/emoji-config.yaml ]; then
          echo "âš ï¸ Keine Konfiguration gefunden, verwende Standard-Config"
          mkdir -p .github
          cat > .github/emoji-config.yaml << 'EOF'
        detection:
          mode: "strict"
          file_extensions: [".py", ".js", ".ts", ".java", ".cpp", ".c"]
          exclude_dirs: [".git", "node_modules", "__pycache__"]
        whitelist:
          comments_allowed: ["âœ…", "âŒ", "âš ï¸"]
        actions:
          block_pr: true
        severity:
          code: "error"
          comments: "warning"
        EOF
        fi
        
        echo "ğŸ“‹ Konfiguration:"
        cat .github/emoji-config.yaml
    
    - name: ğŸ” Run Emoji Scan
      id: scan
      run: |
        echo "ğŸš€ Starte Emoji-Scan..."
        
        AUTO_FIX="${{ github.event.inputs.auto_fix || 'false' }}"
        SCAN_PATH="${{ github.event.inputs.scan_path || '.' }}"
        
        ARGS="--config .github/emoji-config.yaml --path $SCAN_PATH --github-actions"
        
        if [ "$AUTO_FIX" = "true" ]; then
          ARGS="$ARGS --auto-fix"
          echo "ğŸ”§ Auto-Fix aktiviert"
        fi
        
        # FÃ¼hre Scan aus
        set +e  # Erlaube Exit-Code != 0
        python .github/scripts/advanced-emoji-filter.py $ARGS
        EXIT_CODE=$?
        set -e
        
        # Lese Ergebnisse
        if [ -f emoji-report.json ]; then
          EMOJIS_FOUND=$(python -c "import json; data=json.load(open('emoji-report.json')); print(data['summary']['emojis_found'])")
          BLOCKED_COUNT=$(python -c "import json; data=json.load(open('emoji-report.json')); print(data['blocked_count'])")
          
          echo "emojis-found=$EMOJIS_FOUND" >> $GITHUB_OUTPUT
          echo "blocked-count=$BLOCKED_COUNT" >> $GITHUB_OUTPUT
          echo "report-path=emoji-report.json" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š Ergebnisse: $EMOJIS_FOUND Emojis gefunden, $BLOCKED_COUNT blockiert"
        else
          echo "emojis-found=0" >> $GITHUB_OUTPUT
          echo "blocked-count=0" >> $GITHUB_OUTPUT
        fi
        
        exit $EXIT_CODE
    
    - name: ğŸ“Š Upload Report Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: emoji-detection-report-${{ github.run_number }}
        path: |
          emoji-report.json
          emoji-report.md
          *.emoji-backup
        retention-days: 30
    
    - name: ğŸ’¾ Commit Auto-Fixes
      if: github.event.inputs.auto_fix == 'true' && github.event_name == 'workflow_dispatch'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if git diff --quiet; then
          echo "ğŸ” Keine Ã„nderungen zu committen"
        else
          git add .
          git commit -m "ğŸ”§ Auto-fix: Emojis entfernt [skip ci]"
          git push
          echo "âœ… Auto-fixes committed und gepusht"
        fi

  security-check:
    name: ğŸ›¡ï¸ Security & Quality Check
    needs: emoji-detection
    runs-on: ubuntu-latest
    if: needs.emoji-detection.outputs.blocked-count > 0
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ“¥ Download Report
      uses: actions/download-artifact@v4
      with:
        name: emoji-detection-report-${{ github.run_number }}
    
    - name: ğŸš¨ Security Analysis
      run: |
        echo "ğŸ” Analysiere Sicherheitsimplikationen..."
        
        # PrÃ¼fe auf potentiell gefÃ¤hrliche Emojis in kritischen Bereichen
        CRITICAL_EMOJIS=$(python -c "
        import json
        try:
            with open('emoji-report.json') as f:
                data = json.load(f)
            
            critical = []
            for severity, detections in data.get('by_severity', {}).items():
                if severity == 'error':
                    for d in detections:
                        if d['context_type'] == 'code' and not d['is_whitelisted']:
                            critical.append(f'{d[\"file_path\"]}:{d[\"line_number\"]} - {d[\"emoji\"]}')
            
            print(len(critical))
            for item in critical:
                print(f'::error::{item}')
        except:
            print(0)
        ")
        
        echo "ğŸš¨ Kritische Emojis gefunden: $CRITICAL_EMOJIS"
        
        if [ "$CRITICAL_EMOJIS" -gt 0 ]; then
          echo "::error::Kritische Emojis im Code gefunden! Security-Review erforderlich."
        fi

  notification:
    name: ğŸ“¢ Notifications
    needs: [emoji-detection, security-check]
    runs-on: ubuntu-latest
    if: always() && needs.emoji-detection.outputs.blocked-count > 0
    
    steps:
    - name: ğŸ“¥ Download Report
      uses: actions/download-artifact@v4
      with:
        name: emoji-detection-report-${{ github.run_number }}
    
    - name: ğŸ“§ Create Issue
      if: github.event_name == 'push' || github.event_name == 'schedule'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          let reportContent = '';
          try {
            if (fs.existsSync('emoji-report.md')) {
              reportContent = fs.readFileSync('emoji-report.md', 'utf8');
            } else {
              reportContent = 'ğŸ“Š Detaillierter Report nicht verfÃ¼gbar.';
            }
          } catch (error) {
            reportContent = `âŒ Fehler beim Laden des Reports: ${error.message}`;
          }
          
          const issueTitle = `ğŸš« Emoji Detection Alert - ${new Date().toISOString().split('T')[0]}`;
          const issueBody = `
          # ğŸš« Emoji Detection Alert
          
          **Scan Details:**
          - **Commit:** ${context.sha}
          - **Branch:** ${context.ref}
          - **Trigger:** ${context.eventName}
          - **Emojis Found:** ${{ needs.emoji-detection.outputs.emojis-found }}
          - **Blocked Count:** ${{ needs.emoji-detection.outputs.blocked-count }}
          
          ## ğŸ“‹ Report
          
          ${reportContent}
          
          ## ğŸ”§ Aktionen
          
          1. **Automatisch fixen:** FÃ¼hre Workflow mit \`auto_fix: true\` aus
          2. **Manuell Ã¼berprÃ¼fen:** Lade Report-Artifacts herunter
          3. **Whitelist updaten:** FÃ¼ge erlaubte Emojis zur Konfiguration hinzu
          
          **Report Artifacts:** [Download](${context.payload.repository.html_url}/actions/runs/${context.runId})
          `;
          
          // PrÃ¼fe ob bereits Issue existiert
          const existingIssues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['emoji-detection', 'automated'],
            state: 'open'
          });
          
          if (existingIssues.data.length > 0) {
            // Update existing issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssues.data[0].number,
              body: `ğŸ”„ **Update:** Neuer Emoji-Detection Scan\n\n${issueBody}`
            });
          } else {
            // Create new issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ['security', 'code-quality', 'emoji-detection', 'automated']
            });
          }
    
    - name: ğŸ“± Slack Notification
      if: env.SLACK_WEBHOOK_URL != ''
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: |
          ğŸš« **Emoji Detection Alert**
          
          **Repository:** ${{ github.repository }}
          **Branch:** ${{ github.ref_name }}
          **Emojis Found:** ${{ needs.emoji-detection.outputs.emojis-found }}
          **Blocked:** ${{ needs.emoji-detection.outputs.blocked-count }}
          
          [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  pr-comment:
    name: ğŸ’¬ PR Comment
    needs: emoji-detection
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && needs.emoji-detection.outputs.blocked-count > 0
    
    steps:
    - name: ğŸ“¥ Download Report
      uses: actions/download-artifact@v4
      with:
        name: emoji-detection-report-${{ github.run_number }}
    
    - name: ğŸ’¬ Comment on PR
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          let reportContent = '';
          try {
            if (fs.existsSync('emoji-report.md')) {
              reportContent = fs.readFileSync('emoji-report.md', 'utf8');
            }
          } catch (error) {
            reportContent = 'âŒ Report konnte nicht geladen werden.';
          }
          
          const comment = `
          ## ğŸš« Emoji Detection Results
          
          **Status:** âŒ Emojis gefunden die blockiert werden
          **Count:** ${{ needs.emoji-detection.outputs.blocked-count }} blockierte Emojis
          
          <details>
          <summary>ğŸ“‹ Detaillierter Report</summary>
          
          ${reportContent}
          
          </details>
          
          ### ğŸ”§ Wie beheben?
          
          1. **Emojis entfernen:** Entferne die gefundenen Emojis manuell
          2. **Whitelist:** FÃ¼ge Emojis zur Whitelist hinzu wenn berechtigt
          3. **Auto-Fix:** Nutze \`/emoji-fix\` Kommentar fÃ¼r automatische Behebung
          
          **Downloads:** [Report Artifacts](${context.payload.repository.html_url}/actions/runs/${context.runId})
          `;
          
          // Poste Kommentar
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: comment
          });
          
          // FÃ¼ge Label hinzu
          await github.rest.issues.addLabels({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            labels: ['emoji-detected', 'needs-review']
          });

  block-merge:
    name: ğŸš« Block PR Merge  
    needs: emoji-detection
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && needs.emoji-detection.outputs.blocked-count > 0
    
    steps:
    - name: ğŸš« Fail Check
      run: |
        echo "::error::PR merge blocked due to emoji detection"
        echo "ğŸš« Blocked emojis found: ${{ needs.emoji-detection.outputs.blocked-count }}"
        echo "ğŸ“‹ Please review the emoji detection report and fix issues before merging."
        exit 1