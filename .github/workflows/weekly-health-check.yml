name: üè• Weekly Project Health Check

on:
  schedule:
    # Every Monday at 9 AM UTC
    - cron: '0 9 * * MON'
  workflow_dispatch: # Manual trigger

jobs:
  health-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read
    
    steps:
      - uses: actions/checkout@v4
      
      - name: üìä Analyze Project Health
        id: health
        run: |
          # Initialize metrics
          echo "## üè• Weekly Project Health Report - $(date '+%Y-%m-%d')" > report.md
          echo "" >> report.md
          
          # Check for stale PRs (older than 7 days)
          STALE_PRS=$(gh pr list --state open --json number,title,createdAt --jq '.[] | select((now - (.createdAt | fromdateiso8601)) > 604800) | "\(.number): \(.title)"')
          
          if [ -n "$STALE_PRS" ]; then
            echo "### üö® **Stale PRs (>7 days):**" >> report.md
            echo "$STALE_PRS" | while read line; do
              echo "- PR #$line" >> report.md
            done
            echo "" >> report.md
          fi
          
          # Check for governance violations
          GOVERNANCE_ISSUES=$(gh issue list --label governance-violation --state open --json number,title --jq '.[] | "\(.number): \(.title)"')
          
          if [ -n "$GOVERNANCE_ISSUES" ]; then
            echo "### ‚ö†Ô∏è **Open Governance Issues:**" >> report.md
            echo "$GOVERNANCE_ISSUES" | while read line; do
              echo "- Issue #$line" >> report.md
            done
            echo "" >> report.md
          fi
          
          # Check for high priority items
          HIGH_PRIORITY=$(gh issue list --label priority:high,priority:critical --state open --json number,title,labels --jq '.[] | "\(.number): \(.title) [\(.labels[].name | select(. | startswith("priority:")))]"')
          
          if [ -n "$HIGH_PRIORITY" ]; then
            echo "### üî• **High Priority Items:**" >> report.md
            echo "$HIGH_PRIORITY" | while read line; do
              echo "- Issue #$line" >> report.md
            done
            echo "" >> report.md
          fi
          
          # Repository statistics
          echo "### üìà **Repository Stats:**" >> report.md
          echo "- Open PRs: $(gh pr list --state open --json number | jq '. | length')" >> report.md
          echo "- Open Issues: $(gh issue list --state open --json number | jq '. | length')" >> report.md
          echo "- Critical Issues: $(gh issue list --label priority:critical --state open --json number | jq '. | length')" >> report.md
          echo "" >> report.md
          
          # Recommendations
          echo "### üéØ **Weekly Recommendations:**" >> report.md
          
          if [ -n "$STALE_PRS" ]; then
            echo "- üîÑ **Review stale PRs** - Consider closing or updating" >> report.md
          fi
          
          if [ -n "$GOVERNANCE_ISSUES" ]; then
            echo "- üö® **Address governance violations** - Blocking project progress" >> report.md
          fi
          
          if [ -n "$HIGH_PRIORITY" ]; then
            echo "- üî• **Focus on high priority items** - Critical for project success" >> report.md
          fi
          
          echo "" >> report.md
          echo "---" >> report.md
          echo "*Auto-generated by Weekly Health Check* ü§ñ" >> report.md
          
          # Set output for issue creation
          echo "create_issue=true" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üìã Create Health Report Issue
        if: steps.health.outputs.create_issue == 'true'
        run: |
          REPORT_CONTENT=$(cat report.md)
          
          gh issue create \
            --title "üè• Weekly Health Report - $(date '+%Y-%m-%d')" \
            --body "$REPORT_CONTENT" \
            --label "weekly-report,monitoring,automation" \
            --assignee "jannekbuengener"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}