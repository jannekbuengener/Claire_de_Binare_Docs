name: ğŸ¤– Emoji Fix Bot

on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR Number zum Fixen'
        required: true
        type: string

jobs:
  emoji-bot:
    name: ğŸ¤– Emoji Bot Handler
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event.issue.pull_request && 
       (contains(github.event.comment.body, '/emoji-fix') || 
        contains(github.event.comment.body, '/emoji-check') ||
        contains(github.event.comment.body, '/emoji-whitelist')))
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ” Get PR Info
      id: pr-info
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.payload.issue?.number || '${{ github.event.inputs.pr_number }}';
          
          const pr = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: prNumber
          });
          
          return {
            number: prNumber,
            head_sha: pr.data.head.sha,
            head_ref: pr.data.head.ref,
            base_ref: pr.data.base.ref
          };
    
    - name: ğŸ“¥ Checkout PR Branch
      run: |
        git fetch origin
        git checkout ${{ fromJson(steps.pr-info.outputs.result).head_ref }}
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        pip install regex emoji pyyaml
    
    - name: ğŸ¤– Process Bot Command
      id: bot-command
      run: |
        COMMENT_BODY="${{ github.event.comment.body }}"
        
        if [[ "$COMMENT_BODY" == *"/emoji-fix"* ]]; then
          echo "command=fix" >> $GITHUB_OUTPUT
          echo "ğŸ”§ Auto-Fix Befehl erkannt"
        elif [[ "$COMMENT_BODY" == *"/emoji-check"* ]]; then
          echo "command=check" >> $GITHUB_OUTPUT
          echo "ğŸ” Check Befehl erkannt"
        elif [[ "$COMMENT_BODY" == *"/emoji-whitelist"* ]]; then
          echo "command=whitelist" >> $GITHUB_OUTPUT
          echo "ğŸ“ Whitelist Befehl erkannt"
          
          # Extrahiere Emojis aus Kommentar
          EMOJIS=$(echo "$COMMENT_BODY" | grep -oP '/emoji-whitelist\s+\K.*' || echo "")
          echo "whitelist_emojis=$EMOJIS" >> $GITHUB_OUTPUT
        else
          echo "command=check" >> $GITHUB_OUTPUT
        fi
    
    - name: ğŸ”§ Execute Auto-Fix
      if: steps.bot-command.outputs.command == 'fix'
      run: |
        echo "ğŸ”§ FÃ¼hre Auto-Fix aus..."
        
        # Erstelle Backup
        git add -A
        git stash push -m "backup-before-emoji-fix"
        
        # FÃ¼hre Fix aus
        python .github/scripts/advanced-emoji-filter.py \
          --config .github/emoji-config.yaml \
          --auto-fix \
          --github-actions
        
        # PrÃ¼fe Ã„nderungen
        if git diff --quiet; then
          echo "âœ… Keine Emojis zu fixen gefunden"
          echo "fix_applied=false" >> $GITHUB_ENV
        else
          echo "ğŸ”§ Emojis wurden entfernt"
          echo "fix_applied=true" >> $GITHUB_ENV
          
          # Commit Ã„nderungen
          git config --local user.email "action@github.com"
          git config --local user.name "Emoji Fix Bot"
          git add .
          git commit -m "ğŸ¤– Auto-fix: Emojis entfernt durch Bot-Befehl

AusgefÃ¼hrt durch: @${{ github.event.comment.user.login }}
Command: /emoji-fix
PR: #${{ fromJson(steps.pr-info.outputs.result).number }}"
          
          git push origin ${{ fromJson(steps.pr-info.outputs.result).head_ref }}
        fi
    
    - name: ğŸ“ Update Whitelist
      if: steps.bot-command.outputs.command == 'whitelist'
      run: |
        echo "ğŸ“ Update Whitelist..."
        
        EMOJIS="${{ steps.bot-command.outputs.whitelist_emojis }}"
        
        if [ -n "$EMOJIS" ]; then
          # Backup Config
          cp .github/emoji-config.yaml .github/emoji-config.yaml.backup
          
          # FÃ¼ge Emojis zur Whitelist hinzu
          python -c "
import yaml
import sys

config_path = '.github/emoji-config.yaml'
emojis = '$EMOJIS'.strip().split()

with open(config_path, 'r') as f:
    config = yaml.safe_load(f)

if 'whitelist' not in config:
    config['whitelist'] = {}
if 'comments_allowed' not in config['whitelist']:
    config['whitelist']['comments_allowed'] = []

# FÃ¼ge neue Emojis hinzu
for emoji in emojis:
    if emoji not in config['whitelist']['comments_allowed']:
        config['whitelist']['comments_allowed'].append(emoji)

with open(config_path, 'w') as f:
    yaml.dump(config, f, default_flow_style=False, allow_unicode=True)

print(f'Emojis zur Whitelist hinzugefÃ¼gt: {emojis}')
"
          
          # Commit Update
          git config --local user.email "action@github.com"
          git config --local user.name "Emoji Fix Bot"
          git add .github/emoji-config.yaml
          git commit -m "ğŸ“ Whitelist Update: Emojis hinzugefÃ¼gt

Emojis: $EMOJIS
AusgefÃ¼hrt durch: @${{ github.event.comment.user.login }}
Command: /emoji-whitelist
PR: #${{ fromJson(steps.pr-info.outputs.result).number }}"
          
          git push origin ${{ fromJson(steps.pr-info.outputs.result).head_ref }}
          echo "whitelist_updated=true" >> $GITHUB_ENV
        fi
    
    - name: ğŸ” Run Check
      if: steps.bot-command.outputs.command == 'check' || env.fix_applied == 'true' || env.whitelist_updated == 'true'
      run: |
        echo "ğŸ” FÃ¼hre erneuten Check aus..."
        
        python .github/scripts/advanced-emoji-filter.py \
          --config .github/emoji-config.yaml \
          --github-actions || true
        
        # Lese Ergebnisse
        if [ -f emoji-report.json ]; then
          BLOCKED_COUNT=$(python -c "import json; data=json.load(open('emoji-report.json')); print(data['blocked_count'])")
          echo "blocked_count=$BLOCKED_COUNT" >> $GITHUB_ENV
        else
          echo "blocked_count=0" >> $GITHUB_ENV
        fi
    
    - name: ğŸ’¬ Reply to Comment
      uses: actions/github-script@v7
      with:
        script: |
          const command = '${{ steps.bot-command.outputs.command }}';
          const fixApplied = process.env.fix_applied === 'true';
          const whitelistUpdated = process.env.whitelist_updated === 'true';
          const blockedCount = process.env.blocked_count || '0';
          
          let replyText = `ğŸ¤– **Emoji Bot Response**\n\n`;
          
          if (command === 'fix') {
            if (fixApplied) {
              replyText += `âœ… **Auto-Fix erfolgreich ausgefÃ¼hrt!**\n\n`;
              replyText += `ğŸ”§ Emojis wurden automatisch entfernt und committed.\n`;
              replyText += `ğŸ“‹ Verbleibende blockierte Emojis: ${blockedCount}\n\n`;
              
              if (blockedCount > 0) {
                replyText += `âš ï¸ Einige Emojis konnten nicht automatisch entfernt werden. Bitte manuell Ã¼berprÃ¼fen.\n`;
              } else {
                replyText += `ğŸ‰ Alle blockierten Emojis wurden erfolgreich entfernt!\n`;
              }
            } else {
              replyText += `â„¹ï¸ **Keine Emojis zum Fixen gefunden.**\n\n`;
              replyText += `âœ… Der Code ist bereits emoji-frei!\n`;
            }
          } else if (command === 'whitelist') {
            if (whitelistUpdated) {
              replyText += `âœ… **Whitelist erfolgreich aktualisiert!**\n\n`;
              replyText += `ğŸ“ Emojis wurden zur Whitelist hinzugefÃ¼gt: ${{ steps.bot-command.outputs.whitelist_emojis }}\n`;
              replyText += `ğŸ“‹ Verbleibende blockierte Emojis: ${blockedCount}\n`;
            } else {
              replyText += `âŒ **Whitelist-Update fehlgeschlagen.**\n\n`;
              replyText += `âš ï¸ Bitte Emoji-Liste im Format '/emoji-whitelist ğŸ˜€ ğŸ˜ âœ…' angeben.\n`;
            }
          } else {
            replyText += `ğŸ” **Check-Ergebnisse:**\n\n`;
            replyText += `ğŸ“‹ Aktuelle blockierte Emojis: ${blockedCount}\n`;
            
            if (blockedCount > 0) {
              replyText += `\nâš ï¸ Es wurden noch Emojis gefunden. Nutze:\n`;
              replyText += `- \`/emoji-fix\` fÃ¼r automatisches Entfernen\n`;
              replyText += `- \`/emoji-whitelist ğŸ˜€ ğŸ˜\` fÃ¼r Whitelist-Update\n`;
            } else {
              replyText += `\nğŸ‰ Keine blockierten Emojis gefunden!\n`;
            }
          }
          
          replyText += `\n**VerfÃ¼gbare Befehle:**\n`;
          replyText += `- \`/emoji-check\` - Status Ã¼berprÃ¼fen\n`;
          replyText += `- \`/emoji-fix\` - Automatisch fixen\n`;
          replyText += `- \`/emoji-whitelist ğŸ˜€ ğŸ˜ âœ…\` - Emojis zur Whitelist hinzufÃ¼gen\n`;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: replyText
          });
    
    - name: ğŸ·ï¸ Update PR Labels
      uses: actions/github-script@v7
      with:
        script: |
          const blockedCount = parseInt(process.env.blocked_count || '0');
          const prNumber = ${{ fromJson(steps.pr-info.outputs.result).number }};
          
          // Entferne alte Labels
          const labelsToRemove = ['emoji-detected', 'needs-review', 'emoji-fixed'];
          
          for (const label of labelsToRemove) {
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                name: label
              });
            } catch (error) {
              // Label existiert nicht, ignorieren
            }
          }
          
          // FÃ¼ge neues Label hinzu
          const newLabel = blockedCount > 0 ? 'emoji-detected' : 'emoji-fixed';
          
          await github.rest.issues.addLabels({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
            labels: [newLabel]
          });

  help-command:
    name: â“ Bot Help
    runs-on: ubuntu-latest
    if: |
      github.event.issue.pull_request && 
      (contains(github.event.comment.body, '/emoji-help') || 
       contains(github.event.comment.body, '/emoji'))
    
    steps:
    - name: ğŸ’¬ Show Help
      uses: actions/github-script@v7
      with:
        script: |
          const helpText = `
          ## ğŸ¤– Emoji Bot Hilfe
          
          **VerfÃ¼gbare Befehle:**
          
          ### ğŸ” Check & Status
          - \`/emoji-check\` - ÃœberprÃ¼ft aktuellen Emoji-Status
          - \`/emoji\` - Zeigt diese Hilfe an
          
          ### ğŸ”§ Auto-Fix
          - \`/emoji-fix\` - Entfernt automatisch alle blockierten Emojis
          
          ### ğŸ“ Whitelist Management  
          - \`/emoji-whitelist ğŸ˜€ ğŸ˜ âœ…\` - FÃ¼gt Emojis zur Whitelist hinzu
          - \`/emoji-whitelist âš ï¸ ğŸ”¥ ğŸ’¡\` - Erlaubt spezifische Emojis
          
          ### ğŸ’¡ Tipps
          
          **Erlaubte Emojis standardmÃ¤ÃŸig:**
          - âœ… Checkmark (fÃ¼r TODOs)
          - âŒ X-Mark (fÃ¼r Fehler)
          - âš ï¸ Warning (fÃ¼r Warnungen)
          
          **Workflow:**
          1. Bot erkennt Emojis â†’ PR wird blockiert
          2. Nutze \`/emoji-fix\` fÃ¼r automatische Entfernung
          3. Oder \`/emoji-whitelist ğŸ˜€\` um spezifische Emojis zu erlauben
          4. Bot updated automatisch den PR-Status
          
          **Sicherheit:**
          - Emojis in Code-Kontext werden immer blockiert
          - Emojis in Kommentaren kÃ¶nnen whitelisted werden
          - Auto-Fix erstellt automatisch Backups
          
          ---
          *Emoji Bot v2.0 - Automatisierte Emoji-QualitÃ¤tskontrolle*
          `;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: helpText
          });