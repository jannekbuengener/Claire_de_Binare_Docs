name: ü§ñ Smart PR Automation

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  smart-labeling:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: üîç Analyze PR Changes
        id: analyze
        run: |
          # Get changed files
          FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
          
          # Initialize labels array
          LABELS=""
          GOVERNANCE_VIOLATION=false
          
          # Check for governance violations
          if echo "$FILES" | grep -E "^[^/]*\.md$" | grep -v "^README\.md$"; then
            GOVERNANCE_VIOLATION=true
            LABELS="$LABELS,governance-violation"
          fi
          
          # File-based labeling
          if echo "$FILES" | grep -E "\.(py|ps1|js|ts)$"; then
            LABELS="$LABELS,code-change"
          fi
          
          if echo "$FILES" | grep -E "\.ya?ml$|\.json$"; then
            LABELS="$LABELS,configuration"
          fi
          
          if echo "$FILES" | grep -E "^\.github/"; then
            LABELS="$LABELS,github-actions"
          fi
          
          # Title-based labeling
          TITLE="${{ github.event.pull_request.title }}"
          
          if [[ "$TITLE" =~ \[URGENT\]|\[HOTFIX\]|\[CRITICAL\] ]]; then
            LABELS="$LABELS,priority:critical"
          elif [[ "$TITLE" =~ \[BUG\]|\[FIX\]|fix: ]]; then
            LABELS="$LABELS,type:bug,priority:high"
          elif [[ "$TITLE" =~ \[FEATURE\]|\[ENHANCEMENT\]|feat: ]]; then
            LABELS="$LABELS,type:feature"
          fi
          
          if [[ "$TITLE" =~ \[CODEX\] ]]; then
            LABELS="$LABELS,agent:codex"
          elif [[ "$TITLE" =~ \[COPILOT\] ]]; then
            LABELS="$LABELS,agent:copilot"
          elif [[ "$TITLE" =~ \[GEMINI\] ]]; then
            LABELS="$LABELS,agent:gemini"
          fi
          
          # Output results
          echo "labels=${LABELS#,}" >> $GITHUB_OUTPUT
          echo "governance_violation=$GOVERNANCE_VIOLATION" >> $GITHUB_OUTPUT
          
      - name: üè∑Ô∏è Apply Smart Labels
        if: steps.analyze.outputs.labels
        uses: actions/github-script@v7
        with:
          script: |
            const labels = '${{ steps.analyze.outputs.labels }}'.split(',').filter(l => l.trim());
            
            // Get existing labels to avoid duplicates
            const currentLabels = context.payload.pull_request.labels.map(l => l.name);
            const newLabels = labels.filter(l => !currentLabels.includes(l));
            
            if (newLabels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: newLabels
              });
            }
      
      - name: üö® Block Governance Violations
        if: steps.analyze.outputs.governance_violation == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `## üö® **GOVERNANCE VIOLATION DETECTED**
              
              **Issue:** Documentation files found in Working Repo root
              
              ### ‚ùå **Blocked Files:**
              Working Repo should contain **ONLY executable code**.
              
              ### ‚úÖ **Required Action:**
              Move documentation files to \`Claire_de_Binare_Docs\` repository:
              - Documentation ‚Üí \`Claire_de_Binare_Docs/docs/\`
              - Guides ‚Üí \`Claire_de_Binare_Docs/guides/\`
              - Tools docs ‚Üí \`Claire_de_Binare_Docs/tools/\`
              
              ### üîÑ **Process:**
              1. Move files to Docs Hub
              2. Remove from Working Repo
              3. Update this PR
              
              **This PR is blocked until governance compliance is achieved.**
              
              ---
              *Auto-generated by Smart PR Automation* ü§ñ`
            });