# GitLab CI/CD Pipeline f√ºr Claire de Binare (CDB) v2.0
# Governance-First: Write-Gates technisch durchgesetzt

stages:
  - governance      # CRITICAL: Write-Zone Validation (Governance-Enforcement)
  - quality         # Code Quality (Lint, Format, Type)
  - test            # Tests (Unit, Integration)
  - security        # Security Scans (Secrets, Bandit, Dependencies)
  - docs            # Documentation Checks
  - summary         # Build Summary

variables:
  PYTHON_VERSION: "3.12"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  CACHE_VERSION: "1"

# ============================================
# GOVERNANCE ENFORCEMENT (STAGE 1 - CRITICAL)
# ============================================

write-zone-validation:
  stage: governance
  image: alpine/git:latest
  script:
    - |
      # Check for DELIVERY_APPROVED flag (via tokens)
      if [ -n "${CDB_GITLAB_TOKEN:-}" ] || [ -n "${CDB_GITHUB_TOKEN:-}" ]; then
        echo "‚ö†Ô∏è  DELIVERY_APPROVED=true detected (Token vorhanden)"
        echo "‚ö†Ô∏è  Write-Zone Validation l√§uft, blockiert aber NICHT"
        VALIDATION_MODE="warning"
      else
        echo "‚úì Normal Mode: Write-Zone Validation blockiert bei Verletzung"
        VALIDATION_MODE="strict"
      fi

      # Run validation script
      chmod +x scripts/validate_write_zones.sh

      # Set BASE_REF for merge requests, fallback to main
      if [ -n "${CI_MERGE_REQUEST_TARGET_BRANCH_NAME:-}" ]; then
        export BASE_REF="origin/${CI_MERGE_REQUEST_TARGET_BRANCH_NAME}"
      else
        export BASE_REF="origin/main"
      fi

      export HEAD_REF="HEAD"

      # Run validation
      if ./scripts/validate_write_zones.sh; then
        echo "‚úì Write-Zone Validation PASSED"
        exit 0
      else
        if [ "$VALIDATION_MODE" = "warning" ]; then
          echo "‚ö†Ô∏è  Write-Zone Validation FAILED, aber DELIVERY_APPROVED=true ‚Üí Fortfahren"
          exit 0
        else
          echo "‚ùå Write-Zone Validation FAILED ‚Üí Pipeline blockiert"
          exit 1
        fi
      fi
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "web"'  # Manueller Trigger
  allow_failure: false
  tags:
    - docker

# ============================================
# CODE QUALITY CHECKS
# ============================================

lint:
  stage: quality
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - pip install --upgrade pip
    - pip install ruff
  script:
    - ruff check . --output-format=gitlab
  cache:
    key: ${CI_COMMIT_REF_SLUG}-pip-${CACHE_VERSION}
    paths:
      - .cache/pip
  tags:
    - docker

format-check:
  stage: quality
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - pip install --upgrade pip
    - pip install black==23.12.1
  script:
    - black --check --diff .
  cache:
    key: ${CI_COMMIT_REF_SLUG}-pip-${CACHE_VERSION}
    paths:
      - .cache/pip
  tags:
    - docker

type-check:
  stage: quality
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - pip install --upgrade pip
    - pip install -r requirements.txt -r requirements-dev.txt
  script:
    - mypy services/ --ignore-missing-imports --no-strict-optional
  allow_failure: true  # Nicht blockierend in MVP-Phase
  cache:
    key: ${CI_COMMIT_REF_SLUG}-pip-${CACHE_VERSION}
    paths:
      - .cache/pip
  tags:
    - docker

# ============================================
# TESTS
# ============================================

.test-template: &test-template
  stage: test
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - pip install --upgrade pip
    - pip install -r requirements.txt -r requirements-dev.txt
  cache:
    key: ${CI_COMMIT_REF_SLUG}-pip-${CACHE_VERSION}
    paths:
      - .cache/pip
  tags:
    - docker

test-py311:
  <<: *test-template
  image: python:3.11-slim
  script:
    - |
      pytest -v -m "not e2e and not local_only" \
        --cov=services \
        --cov-report=term-missing \
        --cov-report=xml \
        --cov-report=html
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov/
      - coverage.xml
    expire_in: 30 days

test-py312:
  <<: *test-template
  image: python:3.12-slim
  script:
    - |
      pytest -v -m "not e2e and not local_only" \
        --cov=services \
        --cov-report=term-missing \
        --cov-report=xml \
        --cov-report=html
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov/
      - coverage.xml
    expire_in: 30 days

# ============================================
# SECURITY CHECKS
# ============================================

secrets-scan:
  stage: security
  image: alpine:latest
  before_script:
    - apk add --no-cache curl tar
  script:
    - |
      curl -sSL -o gitleaks.tar.gz https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks_linux_x64.tar.gz
      tar -xzf gitleaks.tar.gz
      ./gitleaks detect --no-git --source . --verbose --exit-code 1
  allow_failure: false  # Secrets M√úSSEN blockieren
  tags:
    - docker

security-audit:
  stage: security
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - pip install --upgrade pip
    - pip install bandit[toml]
  script:
    - bandit -r services/ -f json -o bandit-report.json
  allow_failure: true
  artifacts:
    paths:
      - bandit-report.json
    expire_in: 30 days
  tags:
    - docker

dependency-audit:
  stage: security
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - pip install --upgrade pip
    - pip install pip-audit
  script:
    - pip-audit --requirement requirements.txt --format json --output pip-audit.json || true
  allow_failure: true
  artifacts:
    paths:
      - pip-audit.json
    expire_in: 30 days
  tags:
    - docker

# ============================================
# DOCUMENTATION CHECKS
# ============================================

docs-check:
  stage: docs
  image: node:20-alpine
  before_script:
    - npm install -g markdownlint-cli
  script:
    - markdownlint '**/*.md' --ignore node_modules --ignore .venv || true
  allow_failure: true
  tags:
    - docker

# ============================================
# BUILD SUMMARY
# ============================================

build-summary:
  stage: summary
  image: alpine:latest
  script:
    - |
      echo "========================================="
      echo "üéØ CI/CD Pipeline Summary"
      echo "========================================="
      echo ""
      echo "Pipeline: $CI_PIPELINE_ID"
      echo "Branch: $CI_COMMIT_BRANCH"
      echo "Commit: $CI_COMMIT_SHORT_SHA"
      echo ""
      echo "‚úì All jobs completed"
      echo "========================================="
  when: always
  tags:
    - docker
